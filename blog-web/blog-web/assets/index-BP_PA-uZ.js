import{s as p,V as M,L as b,n as I,m as v,f as u,H as $}from"./index-05qZtuZM.js";import{u as f}from"./file-Dx1FRdn-.js";import{e as _,d as T}from"./scroll-DEbj13Ny.js";function m(s){return p({url:"/chat/sendMsg",method:"post",data:s})}function x(s){return p({url:"/chat/recallMsg",method:"post",data:s})}function C(s){return p({url:"/chat/list",method:"get",params:s})}let c=null;const y=()=>{if(!c){const s=M.extend(b);c=new s,c.$mount(),document.body.appendChild(c.$el)}c.visible=!0},w=()=>{c&&(c.visible=!1)},k={name:"Chat",data(){return{currentNav:"chat",chatList:[{id:1,name:"博客交流群",avatar:this.$store.state.webSiteInfo.logo,lastMessage:"",lastTime:""}],friendsList:[],addFriendDialogVisible:!1,addFriendForm:{userId:"",message:""},messageText:"",ws:null,currentChat:{id:1,name:"博客交流群",avatar:this.$store.state.webSiteInfo.logo,lastMessage:"",lastTime:"12:30",isGroup:!0,messages:[{id:1,type:"",content:"",isPlaying:!1}]},showActionsMenu:!1,selectedMessage:null,actionMenuPosition:{top:"0px",left:"0px"},params:{pageNum:1,pageSize:10},loading:!1,hasMore:!0,countdown:0,countdownTimer:null,heartbeatTimer:null,heartbeatInterval:3e4,reconnectAttempts:0,maxReconnectAttempts:5,shouldReconnect:!0,shouldScrollToBottom:!0,isMobile:!1,isListHidden:!1,selectedFriend:null,onlineCount:0,onlineUsers:[],isVoiceMode:!1,mediaRecorder:null,audioChunks:[],isRecording:!1,audioStartTime:null,audioEndTime:null,audio:null,selectedReplyMessage:null,pastedImages:[]}},watch:{"$store.state.userInfo":{handler(s,e){s?this.init():(this.$router.push("/login"),this.ws&&this.ws.close())},deep:!0}},created(){if(!this.$store.state.userInfo){this.$router.push("/login");return}this.init(),this.$nextTick(()=>{T()}),this.checkMobile(),window.addEventListener("resize",this.checkMobile)},beforeDestroy(){this.shouldReconnect=!1,this.stopHeartbeat(),this.ws&&this.ws.close();const s=this.$refs.messageContainer;s&&s.removeEventListener("scroll",this.handleScroll),this.countdownTimer&&clearInterval(this.countdownTimer),_(),window.removeEventListener("resize",this.checkMobile)},computed:{},methods:{switchNav(s){this.currentNav=s,this.selectedFriend=null,s==="friends"?this.loadFriendsList():s==="chat"&&this.$nextTick(()=>{this.scrollToBottom();const e=this.$refs.messageContainer;e&&e.addEventListener("scroll",this.handleScroll),this.hasMore=!0,this.params.pageNum=1})},async init(){this.connectWebSocket(),await this.getChatList(),this.$nextTick(()=>{const s=this.$refs.messageContainer;s&&s.addEventListener("scroll",this.handleScroll),setTimeout(()=>{this.scrollToBottom()},300)})},async getChatList(){y();const s=await C(this.params);this.currentChat.messages=s.data.records,this.params.pageNum===1&&this.currentChat.messages.length>0&&(this.currentChat.lastTime=u(this.currentChat.messages[0].time),this.currentChat.messages[0].isRecalled?this.currentChat.lastMessage="消息已撤回":this.currentChat.lastMessage=this.currentChat.messages[0].type==="text"?this.currentChat.messages[0].content:this.currentChat.messages[0].type==="image"?"[图片]":this.currentChat.messages[0].type==="audio"?"[语音] "+this.currentChat.messages[0].duration+"秒":"[文件]"),this.currentChat.messages.reverse(),this.currentChat.messages.forEach(e=>{e.time=u(e.time)}),this.handlePreCode(),w()},connectWebSocket(){try{const s="wss://blog-server.wcgmallcwj.online/websocket/";this.ws=new WebSocket(s+this.$store.state.userInfo.id),this.ws.onopen=()=>{console.log("WebSocket连接已建立"),this.reconnectAttempts=0,this.startHeartbeat()},this.ws.onmessage=e=>{console.log("收到原始消息:",e.data);try{const t=JSON.parse(e.data);if(t.type==="ping")return;this.handleIncomingMessage(t)}catch(t){console.error("解析消息失败:",t)}},this.ws.onclose=()=>{console.log("WebSocket连接已关闭"),this.stopHeartbeat(),this.reconnect()},this.ws.onerror=e=>{console.error("WebSocket错误:",e),this.stopHeartbeat()}}catch(s){console.error("建立WebSocket连接失败:",s)}},handleIncomingMessage(s){if(console.log("收到消息:",s),typeof s=="string")try{s=JSON.parse(s)}catch(t){console.error("消息格式错误:",t);return}if(s.isRecalled){const t=this.currentChat.messages.findIndex(a=>a.id===s.id);t!==-1&&(this.currentChat.messages[t].content=s.content,this.currentChat.messages[t].isRecalled=s.isRecalled);return}s.type==="text"&&(s.content=s.content.replace(/@(\S+)\s/g,"<mention>@$1</mention> "));const e={id:s.id||Date.now()+Math.random(),type:s.type||"text",content:s.content,time:u(new Date),userId:s.userId,name:s.name,avatar:s.avatar,sex:s.sex,location:s.location,fileSize:s.fileSize,fileName:s.fileName,duration:s.duration,isPlaying:!1,replyId:s.replyId||null,replyContent:s.replyContent||null,replyUserName:s.replyUserName||null};this.currentChat.messages.push(e),this.currentChat.lastMessage=s.type==="text"?s.content:s.type==="image"?"[图片]":s.type==="audio"?"[语音] "+s.duration+"秒":"[文件]",this.currentChat.lastTime="刚刚",this.shouldScrollToBottom=!0,this.$nextTick(()=>{this.scrollToBottom()}),setTimeout(()=>{this.handlePreCode()},100)},async handlePreCode(){await this.$nextTick(),document.querySelectorAll("pre code").forEach(s=>{$.highlightBlock(s)}),this.addCopyButtons()},addCopyButtons(){const s=document.querySelectorAll(".message-content pre");s.length&&s.forEach(e=>{if(e.querySelector(".code-header"))return;const t=document.createElement("div");t.className="code-header";const a=document.createElement("button");a.className="copy-button",a.innerHTML='<i class="fas fa-copy"></i> 复制',a.title="复制代码",a.addEventListener("click",async()=>{try{const n=e.querySelector("code");await navigator.clipboard.writeText(n.textContent),a.innerHTML='<i class="fas fa-check"></i> 已复制',a.classList.add("copied"),setTimeout(()=>{a.innerHTML='<i class="fas fa-copy"></i> 复制',a.classList.remove("copied")},2e3),this.$message.success("复制成功")}catch{this.$message.error("复制失败，请手动复制")}}),t.appendChild(a),e.appendChild(t)})},async sendMessage(){var s,e,t,a;if(!(!this.messageText.trim()&&this.pastedImages.length===0||!this.$store.state.userInfo||this.countdown>0))try{if(this.messageText.trim()){const n={type:"text",content:this.messageText,name:this.$store.state.userInfo.nickname,userId:this.$store.state.userInfo.id,avatar:this.$store.state.userInfo.avatar,sex:this.$store.state.userInfo.sex,replyId:((s=this.selectedReplyMessage)==null?void 0:s.id)||null,replyContent:((e=this.selectedReplyMessage)==null?void 0:e.content)||null,replyUserId:((t=this.selectedReplyMessage)==null?void 0:t.userId)||null,replyUserName:((a=this.selectedReplyMessage)==null?void 0:a.name)||null};await m(n)}this.$refs.messageInput.innerHTML="",this.messageText="",this.selectedReplyMessage=null;for(const n of this.pastedImages){const o=new FormData;o.append("file",n.file);const l=await f(o,"chat");l.data&&await this.sendImage(l.data)}this.startCountdown(),this.shouldScrollToBottom=!0,this.pastedImages=[]}catch(n){console.error("发送消息失败:",n),this.$message.error("发送失败，请重试")}},async sendImage(s){if(!this.$store.state.userInfo)return;const e={type:"image",content:s,self:!0,name:this.$store.state.userInfo.nickname,userId:this.$store.state.userInfo.id,avatar:this.$store.state.userInfo.avatar,sex:this.$store.state.userInfo.sex};try{const t=await m(e);this.shouldScrollToBottom=!0}catch(t){console.error("发送图片失败:",t),this.$message.error("发送失败，请重试")}},scrollToBottom(){const s=this.$refs.messageContainer;s&&(s.scrollTop=s.scrollHeight)},insertEmoji(s){const e=`<img src="${s}" class="emoji" style="width: 30px; height: 30px; vertical-align: middle;">`,t=this.$refs.messageInput;t.focus(),document.execCommand("insertHTML",!1,e),this.messageText=t.innerHTML},previewImage(s){this.$refs.imagePreview.show(s)},showMessageActions(s,e){this.selectedMessage=s,this.showActionsMenu=!0,this.actionMenuPosition={top:`${e.clientY}px`,left:`${e.clientX}px`},setTimeout(()=>{document.addEventListener("click",this.closeActionsMenu)},0)},closeActionsMenu(){this.showActionsMenu=!1,this.selectedMessage=null,document.removeEventListener("click",this.closeActionsMenu)},async recallMessage(){if(this.selectedMessage){try{const s={id:this.selectedMessage.id},e=await x(s)}catch(s){this.$message.error(s.message||"撤回失败，请重试")}this.closeActionsMenu()}},handleSearch(){this.$message.info("搜索功能暂未实现")},async handleDownloadFile(){try{let s=this.selectedMessage.fileName,t=await(await fetch(this.selectedMessage.content)).blob(),a=URL.createObjectURL(t);const n=document.createElement("a");n.href=a,n.download=s,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}catch{this.$message.error("下载失败，请重试")}},handleImageLoad(){this.shouldScrollToBottom&&this.scrollToBottom()},async loadMoreMessages(){if(!(this.loading||!this.hasMore)){this.loading=!0,this.shouldScrollToBottom=!1;try{const s=this.$refs.messageContainer,e=s.scrollHeight;this.params.pageNum++;const t=await C(this.params);if(t.data&&t.data.records&&t.data.records.length>0){const a=t.data.records.map(n=>({...n,time:u(n.time)}));this.currentChat.messages.unshift(...a.reverse()),t.data.records.length<this.params.pageSize&&(this.hasMore=!1),this.$nextTick(()=>{const n=s.scrollHeight;s.scrollTop=n-e,this.handlePreCode()})}else this.hasMore=!1}catch(s){console.error("加载历史消息失败:",s),this.$message.error("加载历史消息失败")}finally{this.loading=!1}}},startCountdown(){this.countdown=3,this.countdownTimer&&clearInterval(this.countdownTimer),this.countdownTimer=setInterval(()=>{this.countdown>0?this.countdown--:clearInterval(this.countdownTimer)},1e3)},startHeartbeat(){this.stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify({type:"ping",timestamp:new Date().getTime()})):(this.stopHeartbeat(),this.reconnect())},this.heartbeatInterval)},stopHeartbeat(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)},reconnect(){if(!this.shouldReconnect)return;if(this.reconnectAttempts>=this.maxReconnectAttempts){console.log("达到最大重连次数，停止重连"),this.$message.error("网络连接异常，请刷新页面重试");return}this.reconnectAttempts++,console.log(`第 ${this.reconnectAttempts} 次尝试重连...`);const s=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);setTimeout(()=>{this.shouldReconnect&&this.$store.state.userInfo&&this.connectWebSocket()},s)},splitIpAddress(s){return s?s.split("|")[1]:"未知"},handleEnterKey(s){if(s.ctrlKey){const e=this.$refs.messageInput,t=e.selectionStart,a=e.selectionEnd;this.messageText=this.messageText.substring(0,t)+`
`+this.messageText.substring(a),this.$nextTick(()=>{e.selectionStart=e.selectionEnd=t+1})}else this.sendMessage()},handleInput(s){const e=this.$refs.messageInput;this.messageText=e.innerHTML,e.innerHTML.trim()===""?e.setAttribute("data-empty","true"):e.setAttribute("data-empty","false")},handleMentionKeydown(s){if(!this.showMentionList)return;const e=this.getFilteredUsers();switch(s.key){case"ArrowDown":s.preventDefault(),this.selectedMentionIndex=Math.min(this.selectedMentionIndex+1,e.length-1);break;case"ArrowUp":s.preventDefault(),this.selectedMentionIndex=Math.max(this.selectedMentionIndex-1,0);break;case"Enter":s.preventDefault(),this.selectedMentionIndex>=0&&this.selectMentionUser(e[this.selectedMentionIndex]);break;case"Escape":s.preventDefault(),this.showMentionList=!1;break}},selectMentionUser(s){const e=this.$refs.messageInput,t=e.innerText,a=e.selectionStart,n=t.lastIndexOf("@",a-1);n!==-1&&(this.messageText=t.substring(0,n)+`@${s.name} `+t.substring(a),this.$nextTick(()=>{const o=n+s.nickname.length+2;e.focus(),e.setSelectionRange(o,o)})),this.showMentionList=!1},getFilteredUsers(){return this.mentionUsers.filter(s=>s.nickname.toLowerCase().includes(this.mentionFilter.toLowerCase()))},getCaretCoordinates(s,e){const t=document.createElement("div"),a=window.getComputedStyle(s),n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"];t.style.position="absolute",t.style.visibility="hidden",n.forEach(i=>{t.style[i]=a[i]}),t.textContent=s.value.substring(0,e);const o=document.createElement("span");o.textContent=s.value.substring(e)||".",t.appendChild(o),document.body.appendChild(t);const l={top:o.offsetTop+parseInt(a.borderTopWidth)+parseInt(a.paddingTop),left:o.offsetLeft+parseInt(a.borderLeftWidth)+parseInt(a.paddingLeft)};return document.body.removeChild(t),l},handleAvatarContextMenu(s,e){e.preventDefault(),s.userId!==this.$store.state.userInfo.id&&(this.selectedMessage=s,this.showActionsMenu=!0,this.actionMenuPosition={top:`${e.clientY}px`,left:`${e.clientX}px`},setTimeout(()=>{document.addEventListener("click",this.closeActionsMenu)},0))},mentionUser(){if(!this.selectedMessage)return;const s={nickname:this.selectedMessage.name},e=this.$refs.messageInput,t=`@${s.nickname} `;this.messageText+=t,e.innerHTML+=t;const a=document.createRange(),n=window.getSelection();a.selectNodeContents(e),a.collapse(!1),n.removeAllRanges(),n.addRange(a),this.closeActionsMenu(),e.focus()},formatMessageContent(s){if(s==="***")return s;if(s.includes("<img")){const t=v(s);return s.includes("code")||(s=s.replace(/\n/g,"<br>")),t.includes("<mention>")?t:t.replace(/@(\S+)\s/g,"<mention>@$1</mention> ")}s=s.replace(/\((https?:\/\/[^\s)]+)\)/g,'<img src="$1" class="emoji" style="width: 22px; height: 22px; vertical-align: middle;">');const e=v(s);return s.includes("code")||(s=s.replace(/\n/g,"<br>")),e.includes("<mention>")?e:e.replace(/@(\S+)\s/g,"<mention>@$1</mention> ")},toggleList(){this.isMobile&&(this.isListHidden=!this.isListHidden)},checkMobile(){const s=window.innerWidth;this.isMobile=s<=768,this.isMobile?this.isListHidden=!0:this.isListHidden=!1},selectFriend(s){this.selectedFriend=s},sendMessageToFriend(){this.$message.info(`发送信息给 ${this.selectedFriend.name}`)},deleteFriend(){this.$message.info(`删除好友 ${this.selectedFriend.name}`)},async handleFileUpload(s){y();const e=s.target.files[0];if(e){try{const t=new FormData;t.append("file",e);const a=await f(t,"chat");a.data&&(e.type.includes("image")?await this.sendImage(a.data):await this.sendFile(a.data,e.name,e.size))}catch(t){console.error("文件上传失败:",t),this.$message.error("文件上传失败")}finally{w()}s.target.value=""}},async sendFile(s,e,t){if(!this.$store.state.userInfo)return;const a={type:"file",content:s,fileName:e,fileSize:t,name:this.$store.state.userInfo.nickname,userId:this.$store.state.userInfo.id,avatar:this.$store.state.userInfo.avatar,sex:this.$store.state.userInfo.sex};try{const n=await m(a);this.shouldScrollToBottom=!0}catch(n){console.error("发送文件失败:",n),this.$message.error("发送失败，请重试")}},formatFileSize(s){return s<1024?s+" B":s<1024*1024?(s/1024).toFixed(2)+" KB":s<1024*1024*1024?(s/(1024*1024)).toFixed(2)+" MB":(s/(1024*1024*1024)).toFixed(2)+" GB"},toggleVoiceMode(){this.isVoiceMode=!this.isVoiceMode},startRecording(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){this.$message.error("当前浏览器不支持录音功能");return}navigator.mediaDevices.getUserMedia({audio:!0}).then(s=>{this.audioStartTime=new Date,this.mediaRecorder=new MediaRecorder(s),this.mediaRecorder.start(),this.audioChunks=[],this.mediaRecorder.ondataavailable=e=>{this.audioChunks.push(e.data)},this.isRecording=!0}).catch(s=>{console.error("录音失败:",s),this.$message.error("录音失败，请检查麦克风权限")})},stopRecording(){if(this.mediaRecorder&&this.mediaRecorder.state!=="inactive"){this.audioEndTime=new Date;let s=Math.ceil((this.audioEndTime-this.audioStartTime)/1e3);if(s<3){this.$message.error("录音时间太短，请重新录音");return}this.mediaRecorder.stop(),this.mediaRecorder.onstop=async()=>{const e=new Blob(this.audioChunks,{type:"audio/wav"}),t=new FormData;t.append("file",e,new Date().getTime()+".wav");try{const a=await f(t,"chat");a.data&&await this.sendAudio(a.data,s)}catch(a){console.error("语音上传失败:",a),this.$message.error("语音上传失败")}this.isRecording=!1,this.mediaRecorder.stream&&this.mediaRecorder.stream.getTracks().forEach(a=>a.stop())}}},cancelRecording(){this.mediaRecorder&&this.mediaRecorder.state!=="inactive"&&(this.mediaRecorder.stop(),this.audioChunks=[],this.$message.info("录音已取消"),this.isRecording=!1,this.mediaRecorder.stream&&this.mediaRecorder.stream.getTracks().forEach(s=>s.stop()))},async sendAudio(s,e){if(!this.$store.state.userInfo)return;const t={type:"audio",content:s,duration:e,name:this.$store.state.userInfo.nickname,userId:this.$store.state.userInfo.id,avatar:this.$store.state.userInfo.avatar,sex:this.$store.state.userInfo.sex};try{const a=await m(t);this.shouldScrollToBottom=!0}catch(a){console.error("发送语音失败:",a),this.$message.error("发送失败，请重试")}},toggleAudioPlayback(s,e){if(this.audio){this.audio.pause(),this.$set(s,"isPlaying",!1),this.audio=null;return}this.audio=new Audio(s.content),this.audio.play().then(()=>{this.$set(s,"isPlaying",!0),this.audio.onended=()=>{this.$set(s,"isPlaying",!1),this.audio=null}}).catch(t=>{this.audio=null,console.error("音频播放失败:",t),this.$message.error("音频播放失败，请检查音频格式或网络连接")})},formatAudioDuration(s){const e=Math.floor(s/60),t=s%60;return`${e}:${t<10?"0":""}${t}`},async scrollToMessage(s){const e=this.$refs.messageContainer;let t=e.querySelector(`[data-message-id="${s}"]`);for(;!t&&this.hasMore;)await this.loadMoreMessages(),t=e.querySelector(`[data-message-id="${s}"]`);if(t){const n=t.offsetTop-100;e.scrollTo({top:n,behavior:"smooth"}),t.classList.add("active-message"),setTimeout(()=>{t.classList.remove("active-message")},2e3)}else this.$message.error("未能找到该消息，请尝试手动加载更多历史消息。")},replyToMessage(){this.selectedReplyMessage=this.selectedMessage,this.closeActionsMenu(),this.$nextTick(()=>{this.$refs.messageInput.focus()})},cancelReply(){this.selectedReplyMessage=null},generateUniqueKey(s,e){return s.id||`msg-${s.userId}-${e}-${Date.now()}`},async handlePaste(s){const e=s.clipboardData.items;for(let t of e)if(t.type.startsWith("image/")){if(this.pastedImages.length>=3){this.$message.error("最多只能粘贴3张图片");return}s.preventDefault();const a=t.getAsFile();if(a.size>5*1024*1024){this.$message.error("图片大小不能超过5MB");return}const n=new FileReader;n.onload=o=>{this.pastedImages.push({file:a,preview:o.target.result})},n.readAsDataURL(a);break}},removeImage(s){this.pastedImages.splice(s,1)},showAddFriendDialog(){var s;this.addFriendForm.message=`我是${((s=this.$store.state.userInfo)==null?void 0:s.nickname)||""}，请求添加您为好友`,this.addFriendDialogVisible=!0},handleCloseAddFriendDialog(){this.addFriendDialogVisible=!1,this.$refs.addFriendForm.resetFields()},async loadFriendsList(){try{this.friendsList=[{id:1,name:"张三",avatar:"https://foruda.gitee.com/avatar/1677004143848886034/2106773_hhf1237_1647845148.png",signature:"热爱生活，热爱编程。",gender:"男",online:!0},{id:2,name:"李四",avatar:"https://foruda.gitee.com/avatar/1677079463351115261/7467101_unique_perfect_1638710768.png",signature:"旅行是我的灵魂。",gender:"女",online:!1}],this.filteredFriendsList=[...this.friendsList]}catch(s){console.error("加载好友列表失败:",s),this.$message.error("加载好友列表失败")}},sendMessageToFriend(){if(!this.selectedFriend){this.$message.warning("请选择好友");return}this.$message.info(`即将与 ${this.selectedFriend.name} 开始聊天`)},async deleteFriend(){if(!this.selectedFriend){this.$message.warning("请选择好友");return}try{await this.$confirm(`确定要删除好友 ${this.selectedFriend.name} 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),this.$message.success("删除成功"),this.selectedFriend=null,this.loadFriendsList()}catch(s){s!=="cancel"&&this.$message.error("删除失败: "+(s.message||"请重试"))}}}};var F=function(){var a,n,o,l;var e=this,t=e._self._c;return t("div",{staticClass:"chat-container"},[t("div",{staticClass:"nav-sidebar"},[t("div",{staticClass:"nav-header"},[t("div",{staticClass:"user-avatar"},[t("img",{attrs:{src:(a=e.$store.state.userInfo)==null?void 0:a.avatar}})])]),t("div",{staticClass:"nav-menu"},[t("div",{staticClass:"nav-item chat-icon",class:{active:e.currentNav==="chat"},on:{click:function(i){return e.switchNav("chat")}}},[t("i",{staticClass:"fas fa-comment"}),t("span",{staticClass:"nav-text"},[e._v("聊天")])]),t("div",{staticClass:"nav-item friends-icon",class:{active:e.currentNav==="friends"},on:{click:function(i){return e.switchNav("friends")}}},[t("i",{staticClass:"fas fa-user-friends"}),t("span",{staticClass:"nav-text"},[e._v("好友")])]),t("div",{staticClass:"nav-item groups-icon",class:{active:e.currentNav==="groups"},on:{click:function(i){return e.switchNav("groups")}}},[t("i",{staticClass:"fas fa-users"}),t("span",{staticClass:"nav-text"},[e._v("群聊")])])])]),t("div",{staticClass:"chat-list-container",class:{"mobile-hidden":e.isMobile&&e.isListHidden}},[e._m(0),t("div",{staticClass:"chat-list"},[e.currentNav==="chat"?e._l(e.chatList,function(i){return t("div",{key:i.id,staticClass:"chat-item",class:{active:e.currentChat.id===i.id}},[t("div",{staticClass:"avatar"},[t("img",{attrs:{src:i.avatar}})]),t("div",{staticClass:"chat-info"},[t("div",{staticClass:"name"},[e._v(e._s(i.name))]),t("div",{staticClass:"last-message",domProps:{innerHTML:e._s(e.currentChat.lastMessage)}})]),t("div",{staticClass:"meta"},[t("div",{staticClass:"time"},[e._v(e._s(e.currentChat.lastTime))])])])}):e.currentNav==="friends"?[t("div",{staticClass:"friends-header"},[t("h3",[e._v("好友列表")]),t("button",{staticClass:"add-friend-btn",on:{click:e.showAddFriendDialog}},[t("i",{staticClass:"fas fa-user-plus"})])]),e._l(e.filteredFriendsList,function(i){return t("div",{key:i.id,staticClass:"friend-item",class:{active:e.selectedFriend&&e.selectedFriend.id===i.id},on:{click:function(d){return e.selectFriend(i)}}},[t("div",{staticClass:"avatar"},[t("img",{attrs:{src:i.avatar}})]),t("div",{staticClass:"friend-info"},[t("div",{staticClass:"name"},[e._v(e._s(i.name))]),t("div",{staticClass:"friend-status",class:{online:i.online}},[e._v(" "+e._s(i.online?"在线":"离线")+" ")])])])}),t("el-dialog",{attrs:{title:"添加好友",visible:e.addFriendDialogVisible,width:"400px","before-close":e.handleCloseAddFriendDialog},on:{"update:visible":function(i){e.addFriendDialogVisible=i}}},[t("el-form",{ref:"addFriendForm",attrs:{model:e.addFriendForm,"label-width":"80px"}},[t("el-form-item",{attrs:{label:"用户ID",prop:"userId",rules:[{required:!0,message:"请输入用户ID",trigger:"blur"}]}},[t("el-input",{attrs:{placeholder:"请输入要添加的用户ID"},model:{value:e.addFriendForm.userId,callback:function(i){e.$set(e.addFriendForm,"userId",i)},expression:"addFriendForm.userId"}})],1),t("el-form-item",{attrs:{label:"申请消息",prop:"message"}},[t("el-input",{attrs:{type:"textarea",placeholder:"请输入申请消息",rows:3},model:{value:e.addFriendForm.message,callback:function(i){e.$set(e.addFriendForm,"message",i)},expression:"addFriendForm.message"}})],1)],1),t("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:e.handleCloseAddFriendDialog}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:e.sendFriendRequest}},[e._v("发送申请")])],1)],1)]:e._e()],2)]),e.currentNav==="chat"?t("div",{staticClass:"chat-main"},[t("div",{staticClass:"chat-header"},[t("div",{staticClass:"user-info"},[e.isMobile?t("div",{staticClass:"toggle-list-btn",on:{click:e.toggleList}},[t("i",{staticClass:"fas fa-bars"})]):e._e(),t("h3",[e._v(e._s(e.currentChat.name))])])]),t("div",{ref:"messageContainer",staticClass:"messages chat-messages"},[e.hasMore?t("div",{staticClass:"load-more-wrapper"},[t("button",{staticClass:"load-more-btn",attrs:{disabled:e.loading},on:{click:e.loadMoreMessages}},[e.loading?t("i",{staticClass:"fas fa-spinner fa-spin"}):e._e(),e._v(" "+e._s(e.loading?"加载中...":"加载更多")+" ")])]):e._e(),e._l(e.currentChat.messages,function(i,d){var h,g;return t("div",{key:e.generateUniqueKey(i,d),class:["message",{"message-self":i.userId===((h=e.$store.state.userInfo)==null?void 0:h.id)},{"active-message":i.id===e.currentChat.id}]},[t("div",{staticClass:"avatar",on:{contextmenu:function(r){return r.preventDefault(),e.handleAvatarContextMenu(i,r)}}},[t("img",{attrs:{src:i.avatar}})]),t("div",{staticClass:"message-content"},[t("div",{staticClass:"message-header"},[e.currentChat.isGroup&&i.userId!==((g=e.$store.state.userInfo)==null?void 0:g.id)?t("div",{staticClass:"sender-name"},[t("span",{class:i.userId===1?"user-name":i.userId===2?"assistant-name":""},[e._v(e._s(i.name))]),i.userId===1?t("span",{staticClass:"author-tag"},[e._v("作者")]):e._e(),i.userId===2?t("span",{staticClass:"assistant-tag"},[e._v("A I")]):e._e(),t("span",{staticClass:"message-time"},[e._v(e._s(i.time))]),t("span",{staticClass:"location"},[e._v(e._s(e.splitIpAddress(i.location)))]),i.sex?t("span",{staticClass:"gender"},[t("i",{class:i.sex===1?"fas fa-mars":"fas fa-venus"})]):e._e()]):e._e()]),i.isRecalled?t("div",{staticClass:"message-recalled"},[t("span",[e._v("消息已撤回")])]):[i.type==="text"?t("div",{staticClass:"message-text",attrs:{"data-message-id":i.id},domProps:{innerHTML:e._s(e.formatMessageContent(i.content))},on:{contextmenu:function(r){return r.preventDefault(),e.showMessageActions(i,r)}}}):i.type==="image"?t("img",{directives:[{name:"lazy",rawName:"v-lazy",value:i.content,expression:"msg.content"}],key:"img-"+(i.id||d),staticClass:"message-image",on:{click:function(r){return e.previewImage(i.content)},load:e.handleImageLoad,contextmenu:function(r){return r.preventDefault(),e.showMessageActions(i,r)}}}):i.type==="file"?t("div",{staticClass:"message-file",on:{contextmenu:function(r){return r.preventDefault(),e.showMessageActions(i,r)}}},[t("i",{staticClass:"fas fa-file-download"}),t("div",{staticClass:"file-info"},[t("a",{attrs:{href:"javascript:void(0)"}},[e._v(e._s(i.fileName))]),t("span",{staticClass:"file-size"},[e._v(e._s(e.formatFileSize(i.fileSize)))])])]):i.type==="audio"?t("div",{staticClass:"message-audio",on:{contextmenu:function(r){return r.preventDefault(),e.showMessageActions(i,r)}}},[t("div",{staticClass:"audio-bubble",on:{click:function(r){return e.toggleAudioPlayback(i,r)}}},[t("i",{class:["fas",i.isPlaying?"fa-pause":"fa-play"]}),t("span",[e._v(e._s(i.duration)+"秒")])])]):e._e()],i.replyId&&!i.isRecalled?t("div",{staticClass:"reply-message",on:{click:function(r){return e.scrollToMessage(i.replyId)}}},[t("span",{staticClass:"reply-content"},[t("i",{staticClass:"el-icon-top"}),e._v(e._s(i.replyUserName)+"："+e._s(i.replyContent)+" ")])]):e._e()],2)])})],2),t("div",{staticClass:"chat-input",staticStyle:{position:"relative"}},[e.selectedReplyMessage?t("div",{staticClass:"reply-preview"},[t("span",{staticClass:"reply-title"},[e._v("回复: "+e._s(e.selectedReplyMessage.content))]),t("i",{staticClass:"fas fa-times",on:{click:e.cancelReply}})]):e._e(),t("div",{staticClass:"input-toolbar"},[t("mj-emoji",{staticClass:"emoji-picker",attrs:{size:"1.1rem"},on:{select:e.insertEmoji}}),e._m(1),t("input",{staticStyle:{display:"none"},attrs:{id:"file-upload",type:"file"},on:{change:e.handleFileUpload}}),t("label",{staticClass:"toolbar-btn voice-toggle-btn",attrs:{title:"语音输入"},on:{click:e.toggleVoiceMode}},[t("i",{staticClass:"fas fa-microphone"})])],1),t("div",{staticClass:"input-area"},[e.isVoiceMode?[t("button",{class:["voice-record-btn",{recording:e.isRecording}],on:{mousedown:e.startRecording,mouseup:e.stopRecording,mouseleave:e.cancelRecording,touchstart:e.startRecording,touchend:e.stopRecording}},[e._v(" "+e._s(e.isRecording?"正在说话中...":"按住说话")+" ")])]:[t("div",{staticClass:"input-wrapper"},[e.pastedImages.length>0?t("div",{staticClass:"paste-preview"},e._l(e.pastedImages,function(i,d){return t("div",{key:d,staticClass:"pasted-image"},[t("img",{attrs:{src:i.preview},on:{click:function(h){return e.previewImage(i.preview)}}}),t("i",{staticClass:"fas fa-times",on:{click:function(h){return e.removeImage(d)}}})])}),0):e._e(),t("div",{ref:"messageInput",staticClass:"message-input",attrs:{contenteditable:"true",placeholder:"输入消息..."},on:{input:e.handleInput,keydown:[function(i){return!i.type.indexOf("key")&&e._k(i.keyCode,"enter",13,i.key,"Enter")?null:(i.preventDefault(),e.handleEnterKey.apply(null,arguments))},e.handleMentionKeydown],paste:e.handlePaste}})])],e.isVoiceMode?e._e():t("button",{attrs:{disabled:!e.messageText.trim()&&e.pastedImages.length===0||e.countdown>0},on:{click:e.sendMessage}},[e.countdown>0?[e._v(" "+e._s(e.countdown)+"s ")]:t("i",{staticClass:"fas fa-paper-plane"})],2)],2)])]):e._e(),t("mj-image-preview",{ref:"imagePreview"}),e.showActionsMenu?t("div",{staticClass:"message-actions-menu",style:e.actionMenuPosition},[e.selectedMessage?[e.selectedMessage.userId!==((n=e.$store.state.userInfo)==null?void 0:n.id)&&e.selectedMessage.isRecalled===!1?t("div",{staticClass:"action-item",on:{click:e.replyToMessage}},[t("i",{staticClass:"fas fa-reply"}),e._v(" 回复 ")]):e._e(),e.selectedMessage.userId!==((o=e.$store.state.userInfo)==null?void 0:o.id)?t("div",{staticClass:"action-item",on:{click:e.mentionUser}},[t("i",{staticClass:"fas fa-at"}),e._v(" TA ")]):e._e(),!e.selectedMessage.isRecalled&&e.selectedMessage.userId===((l=e.$store.state.userInfo)==null?void 0:l.id)?t("div",{staticClass:"action-item",on:{click:e.recallMessage}},[t("i",{staticClass:"fas fa-undo"}),e._v(" 撤回 ")]):e._e(),t("div",{staticClass:"action-item",on:{click:e.handleSearch}},[t("i",{staticClass:"fas fa-search"}),e._v(" 搜索 ")]),e.selectedMessage.type==="file"?t("div",{staticClass:"action-item",on:{click:e.handleDownloadFile}},[t("i",{staticClass:"fas fa-download"}),e._v(" 下载 ")]):e._e()]:e._e()],2):e._e(),e.selectedFriend?t("div",{staticClass:"friend-details"},[t("h3",[e._v(e._s(e.selectedFriend.name))]),t("p",{staticClass:"signature"},[e._v(" 签名："+e._s(e.selectedFriend.signature||"这个人很懒，什么都没写。")+" ")]),t("p",{staticClass:"gender"},[e._v("性别："+e._s(e.selectedFriend.gender||"未知"))]),t("el-button",{attrs:{type:"primary",size:"small",icon:"el-icon-message"},on:{click:e.sendMessageToFriend}},[e._v("发送信息")]),t("el-button",{attrs:{type:"danger",size:"small",icon:"el-icon-delete"},on:{click:e.deleteFriend}},[e._v("删除好友")])],1):e._e()],1)},R=[function(){var s=this,e=s._self._c;return e("div",{staticClass:"search-box"},[e("input",{attrs:{type:"text",placeholder:"搜索"}})])},function(){var s=this,e=s._self._c;return e("label",{staticClass:"toolbar-btn file-upload-btn",attrs:{for:"file-upload",title:"上传文件"}},[e("i",{staticClass:"fas fa-folder"})])}],L=I(k,F,R,!1,null,"4019c7b0");const E=L.exports;export{E as default};
