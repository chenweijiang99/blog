import{n as c,t as h,w as m,x as u,y as g,z as f,A as p}from"./index-05qZtuZM.js";import{e as v}from"./scroll-DEbj13Ny.js";function l(t,e){return t+e}function b(t){return t*t}const y={name:"sliderVerify",props:{blockLength:{type:Number,default:42},blockRadius:{type:Number,default:10},canvasWidth:{type:Number,default:320},canvasHeight:{type:Number,default:155},sliderHint:{type:String,default:"向右滑动"},accuracy:{type:Number,default:3},imageList:{type:Array,default:()=>[]}},data(){return{isFrontCheck:!1,verifyActive:!1,verifySuccess:!1,verifyFail:!1,blockObj:null,canvasCtx:null,blockCtx:null,blockWidth:this.blockLength*2,blockX:void 0,blockY:void 0,image:void 0,originX:void 0,originY:void 0,dragDistanceList:[],sliderBoxWidth:0,sliderButtonLeft:0,isMouseDown:!1,isLoading:!0,timestamp:null,successHint:"",nonceStr:void 0}},mounted(){this.init()},methods:{init(){this.initDom(),this.bindEvents()},initDom(){this.blockObj=this.$refs.block,this.isFrontCheck?(this.canvasCtx=this.$refs.canvas.getContext("2d"),this.blockCtx=this.blockObj.getContext("2d"),this.initImage()):this.getCaptcha()},getCaptcha(){h().then(t=>{const e=t.data;this.nonceStr=e.nonceStr,this.$refs.block.src=e.blockSrc,this.$refs.block.style.top=e.blockY+"px",this.$refs.canvas.src=e.canvasSrc}).finally(()=>{this.isLoading=!1})},initImage(){const t=this.createImage(()=>{this.drawBlock();let{canvasWidth:e,canvasHeight:i,blockX:s,blockY:r,blockRadius:a,blockWidth:o}=this;this.canvasCtx.drawImage(t,0,0,e,i),this.blockCtx.drawImage(t,0,0,e,i);let n=r-a*2,d=this.blockCtx.getImageData(s,n,o,o);this.blockObj.width=o,this.blockCtx.putImageData(d,0,n),this.isLoading=!1,this.nonceStr="loyer"});this.image=t},createImage(t){const e=document.createElement("img");return e.crossOrigin="Anonymous",e.onload=t,e.onerror=()=>{},e.src=this.getImageSrc(),e},getImageSrc(){const t=this.imageList.length;return t>0?this.imageList[this.getNonceByRange(0,t)]:`https://loyer.wang/view/ftp/wallpaper/${this.getNonceByRange(1,1e3)}.jpg`},getNonceByRange(t,e){return Math.round(Math.random()*(e-t)+t)},drawBlock(){this.blockX=this.getNonceByRange(this.blockWidth+10,this.canvasWidth-(this.blockWidth+10)),this.blockY=this.getNonceByRange(10+this.blockRadius*2,this.canvasHeight-(this.blockWidth+10)),this.draw(this.canvasCtx,"fill"),this.draw(this.blockCtx,"clip")},draw(t,e){const i=Math.PI;let{blockX:s,blockY:r,blockLength:a,blockRadius:o}=this;t.beginPath(),t.moveTo(s,r),t.arc(s+a/2,r-o+2,o,.72*i,2.26*i),t.lineTo(s+a,r),t.arc(s+a+o-2,r+a/2,o,1.21*i,2.78*i),t.lineTo(s+a,r+a),t.lineTo(s,r+a),t.arc(s+o-2,r+a/2,o+.4,2.76*i,1.24*i,!0),t.lineTo(s,r),t.lineWidth=2,t.fillStyle="rgba(255, 255, 255, 0.9)",t.strokeStyle="rgba(255, 255, 255, 0.9)",t.stroke(),t[e](),t.globalCompositeOperation="destination-over"},bindEvents(){document.getElementById("slider-button").addEventListener("mousedown",t=>{this.startEvent(t.clientX,t.clientY)}),document.addEventListener("mousemove",t=>{this.moveEvent(t.clientX,t.clientY)}),document.addEventListener("mouseup",t=>{this.endEvent(t.clientX)}),document.getElementById("slider-button").addEventListener("touchstart",t=>{this.startEvent(t.changedTouches[0].pageX,t.changedTouches[0].pageY)}),document.addEventListener("touchmove",t=>{this.moveEvent(t.changedTouches[0].pageX,t.changedTouches[0].pageY)}),document.addEventListener("touchend",t=>{this.endEvent(t.changedTouches[0].pageX)})},checkImgSrc(){return this.isFrontCheck?!0:!!this.$refs.canvas.src},startEvent(t,e){!this.checkImgSrc()||this.isLoading||this.verifySuccess||(this.originX=t,this.originY=e,this.isMouseDown=!0,this.timestamp=+new Date)},moveEvent(t,e){if(!this.isMouseDown)return!1;const i=t-this.originX,s=e-this.originY;if(i<0||i+40>=this.canvasWidth)return!1;this.sliderButtonLeft=i+"px";let r=(this.canvasWidth-40-20)/(this.canvasWidth-40)*i;this.blockObj.style.left=r+"px",this.verifyActive=!0,this.sliderBoxWidth=i+"px",this.dragDistanceList.push(s)},endEvent(t){if(!this.isMouseDown||(this.isMouseDown=!1,t===this.originX))return!1;this.isLoading=!0,this.verifyActive=!1,this.timestamp=+new Date-this.timestamp;const e=parseInt(this.blockObj.style.left);if(this.timestamp>1e4)this.verifyFailEvent();else if(!this.turingTest())this.verifyFail=!0,this.$emit("again");else if(this.isFrontCheck){const i=this.accuracy<=1?1:this.accuracy>10?10:this.accuracy;Math.abs(e-this.blockX)<=i?this.$emit("success",{nonceStr:this.nonceStr,value:e}):this.verifyFailEvent()}else this.$emit("success",{nonceStr:this.nonceStr,value:e})},turingTest(){const t=this.dragDistanceList,e=t.reduce(l)/t.length,i=t.map(r=>r-e),s=Math.sqrt(i.map(b).reduce(l)/t.length);return e!==s},verifySuccessEvent(){this.isLoading=!1,this.verifySuccess=!0;const t=(this.timestamp/1e3).toFixed(1);t<1?this.successHint=`仅仅${t}S，你的速度快如闪电`:t<2?this.successHint=`只用了${t}S，这速度简直完美`:this.successHint=`耗时${t}S，争取下次再快一点`},verifyFailEvent(t){this.verifyFail=!0,this.$emit("fail",t),this.refresh()},refresh(){if(setTimeout(()=>{this.verifyFail=!1},500),this.isLoading=!0,this.verifyActive=!1,this.verifySuccess=!1,this.blockObj.style.left=0,this.sliderBoxWidth=0,this.sliderButtonLeft=0,this.isFrontCheck){let{canvasWidth:t,canvasHeight:e}=this;this.canvasCtx.clearRect(0,0,t,e),this.blockCtx.clearRect(0,0,t,e),this.blockObj.width=t,this.image.src=this.getImageSrc()}else this.getCaptcha()}}};var k=function(){var e=this,i=e._self._c;return i("div",{staticClass:"slide-verify",style:{width:e.canvasWidth+"px"},attrs:{onselectstart:"return false;"}},[e.isLoading?i("div",{class:{"img-loading":e.isLoading},style:{height:e.canvasHeight+"px"}}):e._e(),e.verifySuccess?i("div",{staticClass:"success-hint",style:{height:e.canvasHeight+"px"}},[e._v(" "+e._s(e.successHint)+" ")]):e._e(),i("div",{staticClass:"refresh-icon",on:{click:e.refresh}}),e.isFrontCheck?[i("canvas",{ref:"canvas",staticClass:"slide-canvas",attrs:{width:e.canvasWidth,height:e.canvasHeight}}),i("canvas",{ref:"block",staticClass:"slide-block",attrs:{width:e.canvasWidth,height:e.canvasHeight}})]:[i("img",{ref:"canvas",staticClass:"slide-canvas",attrs:{width:e.canvasWidth,height:e.canvasHeight}}),i("img",{ref:"block",class:["slide-block",{"verify-fail":e.verifyFail}]})],i("div",{staticClass:"slider",class:{"verify-active":e.verifyActive,"verify-success":e.verifySuccess,"verify-fail":e.verifyFail}},[i("div",{staticClass:"slider-box",style:{width:e.sliderBoxWidth}},[i("div",{staticClass:"slider-button",style:{left:e.sliderButtonLeft},attrs:{id:"slider-button"}},[e._m(0)])]),i("span",{staticClass:"slider-hint"},[e._v(e._s(e.sliderHint))])])],2)},w=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"slider-button-icon"},[e("i",{staticClass:"el-icon-arrow-right",staticStyle:{"font-size":"30px",position:"absolute",top:"-10px",left:"-10px"}})])}],C=c(y,k,w,!1,null,"eccaf414");const F=C.exports,_={name:"Login",components:{SliderVerify:F},data(){return{currentForm:"login",cxid:"",loading:!1,wechatForm:{code:"",showQrcode:!1},countdown:0,loginForm:{username:"",password:"",source:"PC"},registerForm:{nickname:"",email:"",password:"",code:""},forgotForm:{email:"",code:"",password:""},loginTypes:{qq:{title:"QQ账号登录",icon:"qq",type:1},wechat:{title:"微信扫码登录",icon:"weichat",type:2},alipay:{title:"支付宝扫码登录",icon:"alipay",type:3},weibo:{title:"微博账号登录",icon:"weibo",type:4},baidu:{title:"百度账号登录",icon:"baidu",type:5},huawei:{title:"华为账号登录",icon:"huawei",type:6},xiaomi:{title:"小米账号登录",icon:"xiaomi",type:7},weiruan:{title:"微软账号登录",icon:"weiruan",type:8},dingding:{title:"钉钉账号登录",icon:"dingding",type:9},gitee:{title:"Gitee账号登录",icon:"gitee",type:10},github:{title:"GitHub账号登录",icon:"github",type:11},douyin:{title:"抖音账号登录",icon:"douyin",type:12}},codeSending:!1,codeButtonText:"发送验证码",codeTimer:null,pollingTimer:null,isShowSliderVerify:!1,sliderVerify:null,showIframeDialog:!1,iframeSrc:"",iframeTitle:"",rules:{nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:3,max:10,message:"长度在 3 到 10 个字符",trigger:"blur"}],username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:3,max:50,message:"长度在 3 到 50 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:6,max:16,message:"长度在 6 到 16 个字符",trigger:"blur"}],code:[{required:!0,message:"请输入验证码",trigger:"blur"}]}}},created(){Object.keys(this.loginTypes).forEach(t=>{this.$store.state.webSiteInfo.loginTypeList.includes(t)||delete this.loginTypes[t]})},methods:{async login(){var t;this.loading=!0;try{await this.$store.dispatch("loginAction",this.loginForm),(t=this.$refs.sliderVerify)==null||t.verifySuccessEvent(),this.$message.success("登录成功"),this.handleClose()}catch(e){this.$message.error(e.message||"登录失败，请重试")}finally{this.loading=!1}},switchForm(t){this.currentForm=t,this.loading=!1},async handleLogin(){this.$refs.ruleFrom.validate(async t=>{if(t)p().then(e=>{!e.data||e.data.configValue==="Y"?this.isShowSliderVerify=!0:this.login()});else return!1})},async handleRegister(){this.$refs.registerForm.validate(async t=>{if(t){this.loading=!0;try{await f(this.registerForm),this.$message.success("注册成功"),this.switchForm("login")}catch(e){this.$message.error(e.message||"注册失败，请重试")}finally{this.loading=!1}}else return console.log("error submit!!"),!1})},async handleResetPassword(){this.$refs.forgotForm.validate(async t=>{if(t){this.loading=!0;try{await g(this.forgotForm),this.$message.success("密码重置成功"),this.switchForm("login")}catch(e){this.$message.error(e.message||"重置失败，请重试")}finally{this.loading=!1}}else return console.log("error submit!!"),!1})},async sendVerificationCode(){if(!this.codeSending){if(!this.forgotForm.email){this.$message.error("请先输入邮箱");return}this.codeSending=!0,this.sendEmailCode(this.forgotForm.email)}},handleThirdPartyLogin(t){u(t).then(e=>{e.code===200&&window.open(e.logurl,"_self")})},handleClose(){this.$router.go(-1)},sendRegisterCode(){if(!this.codeSending){if(!this.registerForm.email){this.$message.error("请先输入邮箱");return}this.codeSending=!0,this.sendEmailCode(this.registerForm.email)}},sendEmailCode(t){m(t).then(e=>{this.$message.success("发送成功，请前往邮箱查看验证码");let i=60;this.codeButtonText=`${i}秒后重试`,this.codeTimer=setInterval(()=>{i--,i<=0?(clearInterval(this.codeTimer),this.codeSending=!1,this.codeButtonText="发送验证码"):this.codeButtonText=`${i}秒后重试`},1e3)}).catch(e=>{this.$message.error(e.message||"发送失败"),this.codeSending=!1})},clearTimer(){this.codeTimer&&clearInterval(this.codeTimer),this.pollingTimer&&clearInterval(this.pollingTimer)},backToHome(){this.$router.push("/")}},beforeDestroy(){v(),this.clearTimer()},watch:{$route(t){const e=t.query.message;e&&this.$message.error(e)}}};var x=function(){var e=this,i=e._self._c;return i("div",[i("div",{staticClass:"login-container"},[i("div",{staticClass:"login-body"},[i("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"回到首页",placement:"top"}},[i("button",{staticClass:"back-btn",on:{click:e.backToHome}},[i("i",{staticClass:"el-icon-back"})])]),i("div",{directives:[{name:"show",rawName:"v-show",value:e.currentForm==="login",expression:"currentForm === 'login'"}],staticClass:"form-container"},[e._m(0),i("el-form",{ref:"ruleFrom",attrs:{model:e.loginForm,rules:e.rules}},[i("el-form-item",{staticClass:"form-item",attrs:{prop:"username"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-user-solid",placeholder:"请输入邮箱",size:"large"},nativeOn:{keyup:function(s){return!s.type.indexOf("key")&&e._k(s.keyCode,"enter",13,s.key,"Enter")?null:e.handleLogin.apply(null,arguments)}},model:{value:e.loginForm.username,callback:function(s){e.$set(e.loginForm,"username",s)},expression:"loginForm.username"}})],1),i("el-form-item",{staticClass:"form-item",attrs:{prop:"password"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-lock",placeholder:"请输入密码","show-password":"",size:"large"},nativeOn:{keyup:function(s){return!s.type.indexOf("key")&&e._k(s.keyCode,"enter",13,s.key,"Enter")?null:e.handleLogin.apply(null,arguments)}},model:{value:e.loginForm.password,callback:function(s){e.$set(e.loginForm,"password",s)},expression:"loginForm.password"}})],1),i("div",{staticClass:"form-options"},[i("el-checkbox",{model:{value:e.rememberMe,callback:function(s){e.rememberMe=s},expression:"rememberMe"}},[e._v("记住我")])],1),i("el-form-item",{staticClass:"form-item"},[i("el-button",{staticClass:"submit-btn ripple",attrs:{loading:e.loading,type:"primary"},on:{click:e.handleLogin}},[e._v(" 登 录 ")])],1)],1),i("div",{staticClass:"form-switch"},[i("a",{on:{click:function(s){return e.switchForm("register")}}},[e._v("立即注册")]),i("span",{staticClass:"divider-line"},[e._v("|")]),i("a",{on:{click:function(s){return e.switchForm("forgot")}}},[e._v("忘记密码?")])]),i("div",{staticClass:"divider"},[i("el-divider",[e._v("选择登录方式")])],1),i("div",{staticClass:"third-party-login"},e._l(e.loginTypes,function(s){return i("div",{on:{click:function(r){return e.handleThirdPartyLogin(s.type)}}},[i("el-tooltip",{attrs:{content:s.title,placement:"top"}},[i("div",{staticClass:"login-icon"},[i("svg-icon",{attrs:{"icon-class":s.icon}})],1)])],1)}),0)],1),i("div",{directives:[{name:"show",rawName:"v-show",value:e.currentForm==="register",expression:"currentForm === 'register'"}],staticClass:"form-container"},[e._m(1),i("el-form",{ref:"registerForm",attrs:{model:e.registerForm,rules:e.rules}},[i("el-form-item",{attrs:{lable:"昵称",prop:"nickname"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-user-solid",placeholder:"请输入昵称"},model:{value:e.registerForm.nickname,callback:function(s){e.$set(e.registerForm,"nickname",s)},expression:"registerForm.nickname"}})],1),i("el-form-item",{staticClass:"form-item",attrs:{prop:"email"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-message",placeholder:"请输入邮箱"},model:{value:e.registerForm.email,callback:function(s){e.$set(e.registerForm,"email",s)},expression:"registerForm.email"}})],1),i("el-form-item",{staticClass:"form-item",attrs:{prop:"code"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-key",placeholder:"请输入验证码"},model:{value:e.registerForm.code,callback:function(s){e.$set(e.registerForm,"code",s)},expression:"registerForm.code"}},[i("template",{slot:"append"},[i("el-button",{attrs:{disabled:e.codeSending},on:{click:e.sendRegisterCode}},[e._v(" "+e._s(e.codeButtonText)+" ")])],1)],2)],1),i("el-form-item",{staticClass:"form-item",attrs:{prop:"password"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-lock",placeholder:"请输入密码","show-password":""},model:{value:e.registerForm.password,callback:function(s){e.$set(e.registerForm,"password",s)},expression:"registerForm.password"}})],1),i("el-form-item",{staticClass:"form-item"},[i("el-button",{staticClass:"submit-btn",attrs:{loading:e.loading},on:{click:e.handleRegister}},[e._v(" 注 册 ")])],1),i("div",{staticClass:"form-switch"},[e._v(" 已有账号？"),i("a",{on:{click:function(s){return e.switchForm("login")}}},[e._v("立即登录")])])],1)],1),i("div",{directives:[{name:"show",rawName:"v-show",value:e.currentForm==="forgot",expression:"currentForm === 'forgot'"}],staticClass:"form-container"},[e._m(2),i("el-form",{ref:"forgotForm",attrs:{model:e.forgotForm,rules:e.rules}},[i("el-form-item",{staticClass:"form-item",attrs:{prop:"email"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-message",placeholder:"请输入注册邮箱"},model:{value:e.forgotForm.email,callback:function(s){e.$set(e.forgotForm,"email",s)},expression:"forgotForm.email"}})],1),i("el-form-item",{staticClass:"form-item",attrs:{prop:"code"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-key",placeholder:"请输入验证码"},model:{value:e.forgotForm.code,callback:function(s){e.$set(e.forgotForm,"code",s)},expression:"forgotForm.code"}},[i("template",{slot:"append"},[i("el-button",{attrs:{disabled:e.codeSending},on:{click:e.sendVerificationCode}},[e._v(" "+e._s(e.codeButtonText)+" ")])],1)],2)],1),i("el-form-item",{staticClass:"form-item",attrs:{prop:"password"}},[i("el-input",{attrs:{"prefix-icon":"el-icon-lock",placeholder:"请输入新密码","show-password":""},model:{value:e.forgotForm.password,callback:function(s){e.$set(e.forgotForm,"password",s)},expression:"forgotForm.password"}})],1),i("el-form-item",{staticClass:"form-item"},[i("el-button",{staticClass:"submit-btn",attrs:{loading:e.loading},on:{click:e.handleResetPassword}},[e._v(" 重置密码 ")])],1),i("div",{staticClass:"form-switch"},[i("a",{on:{click:function(s){return e.switchForm("login")}}},[e._v("返回登录")])])],1)],1)],1)])])},$=[function(){var t=this,e=t._self._c;return e("div",{staticClass:"form-header"},[e("h2",{staticClass:"form-title"},[t._v("账号密码登录")]),e("p",{staticClass:"form-subtitle"},[t._v("欢迎回来,请输入您的账号")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"form-header"},[e("h2",{staticClass:"form-title"},[t._v("注册账号")]),e("p",{staticClass:"form-subtitle"},[t._v("欢迎注册,请输入您的账号")])])},function(){var t=this,e=t._self._c;return e("div",{staticClass:"form-header"},[e("h2",{staticClass:"form-title"},[t._v("找回账号")]),e("p",{staticClass:"form-subtitle"},[t._v("重置密码,请输入您的邮箱")])])}],S=c(_,x,$,!1,null,"9b626cff");const E=S.exports;export{E as default};
